// schema.prisma
// Configuración de Prisma para CineConnect

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// MODELOS DE BASE DE DATOS
// ========================================

/// Almacena información de usuarios registrados
model Usuario {
  id            Int      @id @default(autoincrement())
  email         String   @unique @db.VarChar(255)
  password      String   @db.VarChar(255)  // Password hasheado con bcrypt
  username      String   @unique @db.VarChar(100)
  fechaCreacion DateTime @default(now()) @map("fecha_creacion")
  
  // Relaciones
  calificaciones Calificacion[]
  listas         Lista[]

  @@map("usuarios")
  @@index([email], name: "idx_usuario_email")
  @@index([username], name: "idx_usuario_username")
}

/// Catálogo de películas obtenidas de TMDB API
model Pelicula {
  id             Int      @id @default(autoincrement())
  titulo         String   @db.VarChar(255)
  año            Int?     @map("año")
  genero         String?  @db.VarChar(100)
  director       String?  @db.VarChar(255)
  sinopsis       String?  @db.Text
  imagenUrl      String?  @map("imagen_url") @db.VarChar(500)
  tmdbId         Int?     @unique @map("tmdb_id")  // ID de la película en TMDB API
  fechaAgregada  DateTime @default(now()) @map("fecha_agregada")
  
  // Relaciones
  calificaciones Calificacion[]
  listas         Lista[]

  @@map("peliculas")
  @@index([genero], name: "idx_peliculas_genero")
  @@index([tmdbId], name: "idx_peliculas_tmdb")
}

/// Calificaciones de usuarios a películas (1-5 estrellas)
model Calificacion {
  id                 Int      @id @default(autoincrement())
  usuarioId          Int      @map("usuario_id")
  peliculaId         Int      @map("pelicula_id")
  puntuacion         Int      // Escala del 1 al 5
  fechaCalificacion  DateTime @default(now()) @map("fecha_calificacion")
  comentario         String?  @db.Text
  fechaActualizacion DateTime?
  
  // Relaciones
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  pelicula  Pelicula @relation(fields: [peliculaId], references: [id], onDelete: Cascade)
  
  // Restricción: Un usuario solo puede calificar una película una vez
  @@unique([usuarioId, peliculaId])
  @@map("calificaciones")
  @@index([usuarioId], name: "idx_calificaciones_usuario")
  @@index([peliculaId], name: "idx_calificaciones_pelicula")
}

/// Listas personales: por_ver y vistas
model Lista {
  id            Int       @id @default(autoincrement())
  usuarioId     Int       @map("usuario_id")
  peliculaId    Int?      @map("pelicula_id")
  tipoLista     String    @map("tipo_lista") @db.VarChar(20)  // Valores: 'por_ver', 'vistas' o 'personalizada'
  nombre        String?   @db.VarChar(255)
  descripcion   String?   @db.Text
  esPrivada     Boolean   @default(false) @map("es_privada")
  fechaAgregada DateTime  @default(now()) @map("fecha_agregada")
  
  // Relaciones
  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  pelicula  Pelicula? @relation(fields: [peliculaId], references: [id], onDelete: Cascade)
  
  // Restricción: Una película solo puede estar una vez en cada tipo de lista por usuario
  @@unique([usuarioId, peliculaId, tipoLista])
  @@map("listas")
  @@index([usuarioId], name: "idx_listas_usuario")
  @@index([peliculaId], name: "idx_listas_pelicula")
  @@index([tipoLista], name: "idx_listas_tipo")
}